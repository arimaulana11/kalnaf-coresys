generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// --- ENUMS ---
// ==========================================

enum ProductType {
  PHYSICAL
  SERVICE
  PARCEL
  DIGITAL
}

enum StockLogType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
  WASTE
  TRANSFER_IN
  TRANSFER_OUT
  VOID_RESTORE
  BUNDLE_UNPACK
  EXPIRED
}

enum TransactionSource {
  OFFLINE_POS
  SHOPEE
  TOKOPEDIA
  TIKTOK_SHOP
}

enum PaymentStatus {
  PAID
  PARTIAL
  UNPAID
  VOID
}

// ==========================================
// --- MULTI-TENANCY & STORES ---
// ==========================================

model tenants {
  id        String    @id @db.Uuid
  name      String    @db.VarChar(150)
  plan      String    @default("basic") @db.VarChar(50)
  isActive  Boolean?  @default(true) @map("is_active")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime? @updatedAt @map("updated_at")

  categories   categories[]
  products     products[]
  stores       stores[]
  tenantAddons tenant_addons[]
  transactions transactions[]
  users        users[]
  taxes        taxes[]
  customers    customers[]
  suppliers    suppliers[]

  @@map("tenants")
}

model stores {
  id            String   @id @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  name          String   @db.VarChar(150)
  address       String?
  phone         String?  @db.VarChar(20)
  logoUrl       String?  @map("logo_url")
  receiptHeader String?  @map("receipt_header")
  receiptFooter String?  @map("receipt_footer")
  isActive      Boolean? @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @updatedAt @map("updated_at")

  inventoryStocks inventory_stock[]
  transactions    transactions[]
  userStores      user_stores[]
  tenant          tenants           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shifts          store_shifts[]

  @@unique([tenantId, name])
  @@map("stores")
}

// ==========================================
// --- MASTER DATA ---
// ==========================================

model customers {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String   @db.VarChar(150)
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(150)
  address   String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       tenants        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions transactions[]

  @@unique([tenantId, phone])
  @@map("customers")
}

model suppliers {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String   @db.VarChar(150)
  contact   String?  @db.VarChar(100)
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(150)
  address   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant        tenants          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockBatches  stock_batches[]
  inventoryLogs inventory_logs[]

  @@unique([tenantId, name])
  @@map("suppliers")
}

// ==========================================
// --- PRODUCT & CATEGORY ---
// ==========================================

model categories {
  id          Int      @id @default(autoincrement())
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?
  categoryId  Int?     @map("category_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   categories?  @relation("CategoryToCategory", fields: [categoryId, tenantId], references: [id, tenantId])
  children categories[] @relation("CategoryToCategory")
  tenant   tenants      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products products[]

  @@unique([id, tenantId])
  @@map("categories")
}

model products {
  id          Int         @id @default(autoincrement())
  tenantId    String      @map("tenant_id") @db.Uuid
  categoryId  Int         @map("category_id")
  name        String      @db.VarChar(100)
  description String?
  type        ProductType @default(PHYSICAL)
  imageUrl    String?     @map("image_url") @db.Text
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  variants     product_variants[]
  productTaxes product_taxes[]
  category     categories         @relation(fields: [categoryId, tenantId], references: [id, tenantId])
  tenant       tenants            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([id, tenantId])
  @@index([tenantId])
  @@index([categoryId])
  @@map("products")
}

model product_variants {
  id         Int     @id @default(autoincrement())
  productId  Int     @map("product_id")
  name       String  @db.VarChar(100)
  sku        String? @db.VarChar(100)
  unitName   String  @map("unit_name") @db.VarChar(20)
  multiplier Int     @default(1)
  isBaseUnit Boolean @default(false) @map("is_base_unit")
  price      Int

  parentVariantId Int?               @map("parent_variant_id")
  parent          product_variants?  @relation("VariantToVariant", fields: [parentVariantId], references: [id])
  children        product_variants[] @relation("VariantToVariant")

  bundleComponents product_components[] @relation("ParentVariant")
  asComponent      product_components[] @relation("ComponentVariant")

  product          products            @relation(fields: [productId], references: [id], onDelete: Cascade)
  stocks           inventory_stock[]
  priceHistories   price_history[]
  transactionItems transaction_items[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sku])
  @@index([productId])
  @@map("product_variants")
}

model product_components {
  id                 Int @id @default(autoincrement())
  parentVariantId    Int @map("parent_variant_id")
  componentVariantId Int @map("component_variant_id")
  qty                Int

  parentVariant    product_variants @relation("ParentVariant", fields: [parentVariantId], references: [id], onDelete: Cascade)
  componentVariant product_variants @relation("ComponentVariant", fields: [componentVariantId], references: [id], onDelete: Cascade)

  @@unique([parentVariantId, componentVariantId])
  @@map("product_components")
}

// ==========================================
// --- INVENTORY LOGIC ---
// ==========================================

model inventory_stock {
  id        Int    @id @default(autoincrement())
  storeId   String @map("store_id") @db.Uuid
  variantId Int    @map("variant_id")
  stockQty  BigInt @default(0) @map("stock_qty")

  variant       product_variants @relation(fields: [variantId], references: [id], onDelete: Cascade)
  store         stores           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  stockBatches  stock_batches[]
  inventoryLogs inventory_logs[]

  @@unique([variantId, storeId])
  @@map("inventory_stocks")
}

model stock_batches {
  id               Int       @id @default(autoincrement())
  inventoryStockId Int       @map("inventory_stock_id")
  supplierId       String?   @map("supplier_id") @db.Uuid
  batchNumber      String?   @map("batch_number")
  qty              Int
  expiryDate       DateTime? @map("expiry_date")
  purchasePrice    Int       @map("purchase_price")
  unitPrice        Int?      @map("unit_price")
  createdAt        DateTime  @default(now()) @map("created_at")

  inventoryStock inventory_stock @relation(fields: [inventoryStockId], references: [id], onDelete: Cascade)
  supplier       suppliers?      @relation(fields: [supplierId], references: [id])

  @@map("stock_batches")
}

model inventory_logs {
  id               Int          @id @default(autoincrement())
  inventoryStockId Int          @map("inventory_stock_id")
  supplierId       String?      @map("supplier_id") @db.Uuid
  type             StockLogType
  qtyChange        Int          @map("qty_change")
  referenceId      String?      @map("reference_id")
  notes            String?
  createdAt        DateTime     @default(now()) @map("created_at")

  supplier       suppliers?      @relation(fields: [supplierId], references: [id])
  inventoryStock inventory_stock @relation(fields: [inventoryStockId], references: [id], onDelete: Cascade)

  @@map("inventory_logs")
}

// ==========================================
// --- TRANSACTIONS ---
// ==========================================

model transactions {
  id              Int               @id @default(autoincrement())
  tenantId        String            @map("tenant_id") @db.Uuid
  storeId         String            @map("store_id") @db.Uuid
  createdBy       String            @map("created_by") @db.Uuid
  shiftId         String            @map("shift_id") @db.Uuid
  customerId      String?           @map("customer_id") @db.Uuid
  customerName    String?           @map("customer_name") @db.VarChar(100)
  totalAmount     Int               @map("total_amount")
  paidAmount      Int               @default(0) @map("paid_amount")
  balanceDue      Int               @default(0) @map("balance_due")
  paymentMethod   String            @map("payment_method")
  paymentStatus   PaymentStatus     @default(PAID) @map("payment_status")
  totalDiscount   Int               @default(0) @map("total_discount")
  transactionDate DateTime          @default(now()) @map("transaction_date") @db.Timestamp(6)
  source          TransactionSource @default(OFFLINE_POS)
  metadata        Json?

  items    transaction_items[]
  tenant   tenants             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  store    stores              @relation(fields: [storeId], references: [id])
  creator  users               @relation(fields: [createdBy], references: [id])
  shift    store_shifts        @relation(fields: [shiftId], references: [id])
  customer customers?          @relation(fields: [customerId], references: [id])

  @@index([tenantId, storeId])
  @@map("transactions")
}

model transaction_items {
  id             Int @id @default(autoincrement())
  transactionId  Int @map("transaction_id")
  variantId      Int @map("product_variant_id")
  qty            Int
  unitPrice      Int @map("unit_price")
  costPrice      Int @map("cost_price")
  taxAmount      Int @default(0) @map("tax_amount")
  discountAmount Int @default(0) @map("discount_amount")
  subtotal       Int

  variant     product_variants @relation(fields: [variantId], references: [id])
  transaction transactions     @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([variantId])
  @@map("transaction_items")
}

model store_shifts {
  id           String    @id @default(uuid()) @db.Uuid
  storeId      String    @map("store_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  startTime    DateTime  @default(now()) @map("start_time")
  endTime      DateTime? @map("end_time")
  startingCash Int       @default(0) @map("starting_cash")
  closingCash  Int?      @map("closing_cash")
  status       String    @default("OPEN")

  store        stores         @relation(fields: [storeId], references: [id])
  user         users          @relation(fields: [userId], references: [id])
  transactions transactions[]

  @@map("store_shifts")
}

// ==========================================
// --- AUTH & USERS ---
// ==========================================

model users {
  id           String    @id @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  name         String?   @db.VarChar(150)
  email        String    @unique @db.VarChar(150)
  passwordHash String    @map("password_hash")
  role         String    @default("owner") @db.VarChar(50)
  isActive     Boolean?  @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamp(6)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime? @updatedAt @map("updated_at")

  refreshTokens refresh_tokens[]
  transactions  transactions[]
  userStores    user_stores[]
  tenant        tenants          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shifts        store_shifts[]

  @@index([tenantId])
  @@map("users")
}

model user_stores {
  userId    String    @map("user_id") @db.Uuid
  storeId   String    @map("store_id") @db.Uuid
  status    String    @default("active") @db.VarChar(20)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at") @db.Timestamp(6)

  store stores @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  users  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, storeId])
  @@map("user_stores")
}

model refresh_tokens {
  id        String    @id @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at") @db.Timestamp(6)
  revoked   Boolean?  @default(false)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}

// ==========================================
// --- TAXES & HISTORY ---
// ==========================================

model taxes {
  id       Int     @id @default(autoincrement())
  tenantId String  @map("tenant_id") @db.Uuid
  name     String  @db.VarChar(50)
  rate     Float
  isActive Boolean @default(true) @map("is_active")

  productTaxes product_taxes[]
  tenant       tenants         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("taxes")
}

model product_taxes {
  productId Int @map("product_id")
  taxId     Int @map("tax_id")

  product products @relation(fields: [productId], references: [id], onDelete: Cascade)
  tax     taxes    @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@id([productId, taxId])
  @@map("product_taxes")
}

model price_history {
  id         Int       @id @default(autoincrement())
  variantId  Int       @map("product_variant_id")
  oldPrice   Int?      @map("old_price")
  newPrice   Int       @map("new_price")
  changeDate DateTime? @default(now()) @map("change_date") @db.Timestamp(6)
  notes      String?

  variant product_variants @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("price_histories")
}

// ==========================================
// --- ADDONS SYSTEM ---
// ==========================================

model addons {
  id           String          @id @db.Uuid
  code         String          @unique @db.VarChar(50)
  name         String          @db.VarChar(150)
  description  String?
  priceMonthly Int             @map("price_monthly")
  createdAt    DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  tenantAddons tenant_addons[]

  @@map("addons")
}

model tenant_addons {
  id          String    @id @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  addonId     String    @map("addon_id") @db.Uuid
  status      String    @default("active") @db.VarChar(20)
  activatedAt DateTime  @default(now()) @map("activated_at") @db.Timestamp(6)
  expiresAt   DateTime? @map("expires_at") @db.Timestamp(6)
  autoRenew   Boolean   @default(true) @map("auto_renew")

  addon  addons  @relation(fields: [addonId], references: [id], onDelete: Cascade)
  tenant tenants @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_addons")
}